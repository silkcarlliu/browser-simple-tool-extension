(function () {
  "use strict";

  // Èò≤Ê≠¢ÈáçÂ§çÊ≥®ÂÖ•
  if (window.pageToolsInjected) return;
  window.pageToolsInjected = true;

  // ÈÖçÁΩÆÂ∏∏Èáè
  const CONFIG = {
    SELECTORS: {
      FLOAT_BTN: "#maybe-page-tools-float-btn",
      POPUP: "#maybe-page-tools-popup",
      PROGRESS: "#maybe-page-tools-progress",
    },
    AD_CLASSES: [
      "ad",
      "ads",
      "advertisement",
      // "banner",
      "sponsor",
      // "popup",
      "ad-container",
    ],
    MAIN_CONTENT_SELECTORS: [
      "main",
      "article",
      "section",
      "[role=main]",
      ".content",
      ".post-content",
    ],
    EXTERNAL_LIBS: {
      JSZIP: "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js",
    },
  };

  // Â∑•ÂÖ∑Á±ª
  class Utils {
    static async loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    static async fetchWithRetry(url, retries = 3) {
      for (let attempt = 0; attempt < retries; attempt++) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.blob();
        } catch (error) {
          if (attempt === retries - 1) throw error;
          await new Promise((resolve) =>
            setTimeout(resolve, 500 * (attempt + 1))
          );
        }
      }
    }

    static getFileExtension(url) {
      const match = url.match(/\.([a-zA-Z0-9]+)(?:\?|$)/);
      return match ? match[1].toLowerCase() : "jpg";
    }

    static showNotification(message, type = "info") {
      const notification = document.createElement("div");
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-family: 'Microsoft YaHei', sans-serif;
        font-size: 14px;
        z-index: 1000001;
        max-width: 300px;
        word-wrap: break-word;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
      `;

      const colors = {
        success: "#4caf50",
        error: "#f44336",
        warning: "#ff9800",
        info: "#2196f3",
      };

      notification.style.backgroundColor = colors[type] || colors.info;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = "0";
        notification.style.transform = "translateX(100%)";
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    static debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  }

  // UIÁÆ°ÁêÜÂô®
  class UIManager {
    constructor() {
      this.floatBtn = null;
      this.popup = null;
      this.progress = null;
      this.isPopupVisible = false;
      this.init();
    }

    init() {
      this.createFloatButton();
      this.createPopup();
      this.bindEvents();
    }

    createFloatButton() {
      this.floatBtn = document.createElement("div");
      this.floatBtn.id = "maybe-page-tools-float-btn";
      this.floatBtn.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
        </svg>
      `;
      document.body.appendChild(this.floatBtn);
    }

    createPopup() {
      this.popup = document.createElement("div");
      this.popup.id = "maybe-page-tools-popup";
      this.popup.style.display = "none";

      this.progress = document.createElement("div");
      this.progress.id = "maybe-page-tools-progress";

      this.popup.appendChild(this.progress);
      document.body.appendChild(this.popup);
    }

    bindEvents() {
      this.floatBtn.addEventListener("click", () => this.togglePopup());

      // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÂºπÁ™ó
      document.addEventListener("click", (e) => {
        if (
          !this.popup.contains(e.target) &&
          !this.floatBtn.contains(e.target)
        ) {
          this.hidePopup();
        }
      });

      // ESCÈîÆÂÖ≥Èó≠ÂºπÁ™ó
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          this.hidePopup();
        }
      });
    }

    togglePopup() {
      if (this.isPopupVisible) {
        this.hidePopup();
      } else {
        this.showPopup();
      }
    }

    showPopup() {
      this.popup.style.display = "flex";
      this.popup.style.flexDirection = "column";
      this.isPopupVisible = true;
    }

    hidePopup() {
      this.popup.style.display = "none";
      this.progress.textContent = "";
      this.isPopupVisible = false;
    }

    updateProgress(message) {
      this.progress.textContent = message;
    }

    addButton(text, onClick) {
      const button = document.createElement("button");
      button.textContent = text;
      button.addEventListener("click", onClick);
      this.popup.appendChild(button);
    }

    clearButtons() {
      const buttons = this.popup.querySelectorAll("button");
      buttons.forEach((btn) => btn.remove());
    }
  }

  // ÂäüËÉΩÁÆ°ÁêÜÂô®
  class FeatureManager {
    constructor(uiManager) {
      this.ui = uiManager;
      this.hoverTip = null;
      this.initFeatures();
    }

    initFeatures() {
      const features = [
        { name: "üîó È´ò‰∫ÆÈìæÊé•", fn: () => this.highlightLinks() },
        { name: "üì∏ È°µÈù¢Êà™Âõæ", fn: () => this.takeScreenshot() },
        { name: "üñºÔ∏è ÂõæÁâáÈìæÊé•", fn: () => this.showImageLinks() },
        { name: "üö´ ÁßªÈô§ÂπøÂëä", fn: () => this.removeAds() },
        { name: "üóëÔ∏è Âà†Èô§ÂÖÉÁ¥†", fn: () => this.enableElementDeletion() },
        { name: "üîç ÂÖÉÁ¥†Ê£ÄÊü•", fn: () => this.toggleElementInspector() },
        { name: "üìÑ ÊèêÂèñÊ≠£Êñá", fn: () => this.extractMainContent() },
        { name: "üíæ ‰∏ãËΩΩÂõæÁâá", fn: () => this.batchDownloadImages() },
        { name: "üì¶ ÊâìÂåÖ‰∏ãËΩΩ", fn: () => this.downloadContainerImages() },
        { name: "üé® Ê†∑ÂºèË∞ÉÊï¥", fn: () => this.adjustPageStyles() },
        { name: "üìä È°µÈù¢ÁªüËÆ°", fn: () => this.showPageStats() },
        { name: "üîß ÂºÄÂèëËÄÖÂ∑•ÂÖ∑", fn: () => this.showDeveloperTools() },
      ];

      features.forEach(({ name, fn }) => {
        this.ui.addButton(name, fn);
      });
    }

    async highlightLinks() {
      try {
        const links = Array.from(document.getElementsByTagName("a"));
        links.forEach((link) => {
          link.style.backgroundColor = "#ffff00";
          link.style.border = "2px dashed #0066cc";
          link.style.padding = "2px";
        });
        Utils.showNotification(`Â∑≤È´ò‰∫Æ ${links.length} ‰∏™ÈìæÊé•`, "success");
      } catch (error) {
        Utils.showNotification("È´ò‰∫ÆÈìæÊé•Êó∂Âá∫Èîô: " + error.message, "error");
      }
    }

    async takeScreenshot() {
      try {
        // Êà™ÂõæÂâçÈöêËóèÊÇ¨ÊµÆÁ™ó
        const floatBtn = document.getElementById("maybe-page-tools-float-btn");
        const popup = document.getElementById("maybe-page-tools-popup");
        const floatBtnDisplay = floatBtn ? floatBtn.style.display : null;
        const popupDisplay = popup ? popup.style.display : null;
        if (floatBtn) floatBtn.style.display = "none";
        if (popup) popup.style.display = "none";

        this.ui.updateProgress("Ê≠£Âú®ÁîüÊàêÊà™Âõæ...");
        
        // ‰ΩøÁî®ChromeÁöÑÂéüÁîüÊà™ÂõæAPI
        chrome.runtime.sendMessage({
          action: 'takeScreenshot'
        }, (response) => {
          // Êà™ÂõæÂêéÊÅ¢Â§çÊÇ¨ÊµÆÁ™ó
          if (floatBtn) floatBtn.style.display = floatBtnDisplay;
          if (popup) popup.style.display = popupDisplay;

          if (response && response.success) {
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const link = document.createElement("a");
            link.download = `screenshot_${new Date()
              .toISOString()
              .slice(0, 19)
              .replace(/:/g, "-")}.png`;
            link.href = response.dataUrl;
            link.click();
            
            this.ui.updateProgress("Êà™ÂõæÂÆåÊàêÔºÅ");
            Utils.showNotification("Êà™ÂõæÂ∑≤‰øùÂ≠ò", "success");
            
            setTimeout(() => this.ui.updateProgress(""), 2000);
          } else {
            this.ui.updateProgress("Êà™ÂõæÂ§±Ë¥•");
            Utils.showNotification("Êà™ÂõæÂ§±Ë¥•: " + (response?.error || "Êú™Áü•ÈîôËØØ"), "error");
          }
        });
      } catch (error) {
        // Êà™ÂõæÂºÇÂ∏∏Êó∂‰πüÊÅ¢Â§çÊÇ¨ÊµÆÁ™ó
        const floatBtn = document.getElementById("maybe-page-tools-float-btn");
        const popup = document.getElementById("maybe-page-tools-popup");
        if (floatBtn) floatBtn.style.display = "";
        if (popup) popup.style.display = "";
        this.ui.updateProgress("Êà™ÂõæÂ§±Ë¥•");
        Utils.showNotification("Êà™ÂõæÂ§±Ë¥•: " + error.message, "error");
      }
    }

    showImageLinks() {
      try {
        const images = Array.from(document.images).filter((img) => img.src);
        const imageUrls = images.map((img) => img.src).join("\n");

        if (imageUrls) {
          const textarea = document.createElement("textarea");
          textarea.value = imageUrls;
          textarea.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            z-index: 1000002;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
          `;
          document.body.appendChild(textarea);
          textarea.select();

          const closeBtn = document.createElement("button");
          closeBtn.textContent = "ÂÖ≥Èó≠";
          closeBtn.style.cssText = `
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000003;
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
          `;
          closeBtn.onclick = () => {
            document.body.removeChild(textarea);
            document.body.removeChild(closeBtn);
          };
          document.body.appendChild(closeBtn);
        } else {
          Utils.showNotification("Êú™ÊâæÂà∞ÂõæÁâá", "warning");
        }
      } catch (error) {
        Utils.showNotification("Ëé∑ÂèñÂõæÁâáÈìæÊé•Â§±Ë¥•: " + error.message, "error");
      }
    }

    removeAds() {
      try {
        let removedCount = 0;

        CONFIG.AD_CLASSES.forEach((className) => {
          const elements = document.querySelectorAll(`[class*="${className}"]`);
          elements.forEach((el) => {
            el.remove();
            removedCount++;
          });
        });

        // ÁßªÈô§Â∏∏ËßÅÁöÑÂπøÂëäiframe
        const adIframes = document.querySelectorAll(
          'iframe[src*="ad"], iframe[src*="ads"]'
        );
        adIframes.forEach((iframe) => {
          iframe.remove();
          removedCount++;
        });

        Utils.showNotification(`Â∑≤ÁßªÈô§ ${removedCount} ‰∏™ÂπøÂëäÂÖÉÁ¥†`, "success");
      } catch (error) {
        Utils.showNotification("ÁßªÈô§ÂπøÂëäÊó∂Âá∫Èîô: " + error.message, "error");
      }
    }

    enableElementDeletion() {
      try {
        Utils.showNotification("ÁÇπÂáªË¶ÅÂà†Èô§ÁöÑÂÖÉÁ¥†ÔºåÊåâESCÂèñÊ∂à", "info");

        const handleClick = (e) => {
          e.preventDefault();
          e.stopPropagation();

          if (
            e.target === document.body ||
            e.target === document.documentElement
          )
            return;

          e.target.style.outline = "2px solid red";
          e.target.style.backgroundColor = "rgba(255, 0, 0, 0.1)";

          if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂÖÉÁ¥†ÂêóÔºü")) {
            e.target.remove();
            Utils.showNotification("ÂÖÉÁ¥†Â∑≤Âà†Èô§", "success");
          } else {
            e.target.style.outline = "";
            e.target.style.backgroundColor = "";
          }

          document.removeEventListener("click", handleClick, true);
        };

        const handleKeydown = (e) => {
          if (e.key === "Escape") {
            document.removeEventListener("click", handleClick, true);
            document.removeEventListener("keydown", handleKeydown);
            Utils.showNotification("Â∑≤ÂèñÊ∂àÂà†Èô§Ê®°Âºè", "info");
          }
        };

        document.addEventListener("click", handleClick, true);
        document.addEventListener("keydown", handleKeydown);
      } catch (error) {
        Utils.showNotification("ÂêØÁî®Âà†Èô§Ê®°ÂºèÂ§±Ë¥•: " + error.message, "error");
      }
    }

    toggleElementInspector() {
      try {
        if (this.hoverTip) {
          this.disableElementInspector();
          return;
        }

        const tip = document.createElement("div");
        tip.style.cssText = `
          position: fixed;
          z-index: 1000000;
          padding: 6px 10px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          font: 12px monospace;
          border-radius: 4px;
          pointer-events: none;
          max-width: 300px;
          word-wrap: break-word;
        `;
        document.body.appendChild(tip);

        const onMouseMove = Utils.debounce((e) => {
          const element = document.elementFromPoint(e.clientX, e.clientY);
          if (element && element !== tip) {
            const tagName = element.tagName.toLowerCase();
            const className = element.className
              ? "." + element.className.replace(/\s+/g, ".")
              : "";
            const id = element.id ? "#" + element.id : "";
            const text = `${tagName}${id}${className}`;

            tip.textContent = text;
            tip.style.left = e.pageX + 10 + "px";
            tip.style.top = e.pageY + 10 + "px";
            tip.style.display = "block";
          }
        }, 50);

        document.addEventListener("mousemove", onMouseMove);
        this.hoverTip = { tip, onMouseMove };

        Utils.showNotification(
          "ÂÖÉÁ¥†Ê£ÄÊü•Âô®Â∑≤ÂêØÁî®ÔºåÈº†Ê†áÊÇ¨ÂÅúÊü•ÁúãÂÖÉÁ¥†‰ø°ÊÅØ",
          "success"
        );
      } catch (error) {
        Utils.showNotification("ÂêØÁî®ÂÖÉÁ¥†Ê£ÄÊü•Âô®Â§±Ë¥•: " + error.message, "error");
      }
    }

    disableElementInspector() {
      if (this.hoverTip) {
        document.removeEventListener("mousemove", this.hoverTip.onMouseMove);
        document.body.removeChild(this.hoverTip.tip);
        this.hoverTip = null;
        Utils.showNotification("ÂÖÉÁ¥†Ê£ÄÊü•Âô®Â∑≤Á¶ÅÁî®", "info");
      }
    }

    extractMainContent() {
      try {
        let mainContent = null;

        for (const selector of CONFIG.MAIN_CONTENT_SELECTORS) {
          mainContent = document.querySelector(selector);
          if (mainContent) break;
        }

        if (mainContent) {
          // ‰øùÂ≠òÂéüÂßãÈ°µÈù¢
          if (!window.originalPageContent) {
            window.originalPageContent = document.body.innerHTML;
          }

          document.body.innerHTML = mainContent.outerHTML;
          Utils.showNotification("Â∑≤ÊèêÂèñÈ°µÈù¢Ê≠£Êñá", "success");
        } else {
          Utils.showNotification("Êú™ÊâæÂà∞‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü", "warning");
        }
      } catch (error) {
        Utils.showNotification("ÊèêÂèñÊ≠£ÊñáÂ§±Ë¥•: " + error.message, "error");
      }
    }

    async batchDownloadImages() {
      try {
        const images = Array.from(document.images).filter((img) => img.src);

        if (images.length === 0) {
          Utils.showNotification("Êú™ÊâæÂà∞ÂõæÁâá", "warning");
          return;
        }

        this.ui.updateProgress(`ÂáÜÂ§á‰∏ãËΩΩ ${images.length} Âº†ÂõæÁâá...`);

        for (let i = 0; i < images.length; i++) {
          const img = images[i];
          this.ui.updateProgress(`‰∏ãËΩΩÁ¨¨ ${i + 1}/${images.length} Âº†ÂõæÁâá...`);

          try {
            const link = document.createElement("a");
            link.href = img.src;
            const ext = Utils.getFileExtension(img.src);
            link.download = `image_${i + 1}.${ext}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // ÈÅøÂÖçÊµèËßàÂô®ÈòªÊ≠¢Â§ö‰∏™‰∏ãËΩΩ
            await new Promise((resolve) => setTimeout(resolve, 100));
          } catch (error) {
            console.error(`‰∏ãËΩΩÂõæÁâáÂ§±Ë¥•: ${img.src}`, error);
          }
        }

        this.ui.updateProgress("‰∏ãËΩΩÂÆåÊàêÔºÅ");
        Utils.showNotification(`Â∑≤Ëß¶Âèë ${images.length} Âº†ÂõæÁâá‰∏ãËΩΩ`, "success");

        setTimeout(() => this.ui.updateProgress(""), 3000);
      } catch (error) {
        this.ui.updateProgress("ÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•");
        Utils.showNotification("ÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•: " + error.message, "error");
      }
    }

    async downloadContainerImages() {
      try {
        this.ui.updateProgress("Ê≠£Âú®Âä†ËΩΩÊâìÂåÖÂ∑•ÂÖ∑...");

        if (!window.JSZip) {
          await Utils.loadScript(CONFIG.EXTERNAL_LIBS.JSZIP);
        }

        const input = prompt(
          "ËØ∑ËæìÂÖ•ÈÄâÊã©Âô®ÂíåÊñá‰ª∂Â§πÂêçÁß∞ÔºåÊ†ºÂºèÔºö.class1=Âõæ‰∏Ä,#id2=Âõæ‰∫åÔºåÂ§ö‰∏™Áî®Ëã±ÊñáÈÄóÂè∑ÂàÜÈöî"
        );

        if (!input) return;

        const pairs = input
          .split(",")
          .map((s) => s.trim())
          .map((str) => {
            const [selector, name] = str.split("=").map((s) => s.trim());
            return {
              selector,
              name: name || selector.replace(/[#\.]/g, "_"),
            };
          });

        const zip = new JSZip();
        const folder = zip.folder("downloaded_media");
        let totalImages = 0;

        for (const { selector, name } of pairs) {
          const container = document.querySelector(selector);
          if (!container) continue;

          const images = Array.from(container.querySelectorAll("img")).filter(
            (img) => img.src
          );
          const subFolder = folder.folder(name);

          for (let i = 0; i < images.length; i++) {
            const img = images[i];
            this.ui.updateProgress(
              `‰∏ãËΩΩ ${name} Á¨¨ ${i + 1}/${images.length} Âº†...`
            );

            try {
              const blob = await Utils.fetchWithRetry(img.src);
              const ext = Utils.getFileExtension(img.src);
              const arrayBuffer = await blob.arrayBuffer();
              subFolder.file(`img_${i + 1}.${ext}`, arrayBuffer);
              totalImages++;
            } catch (error) {
              console.error(`‰∏ãËΩΩÂ§±Ë¥•Ôºö${img.src}`, error);
            }
          }
        }

        this.ui.updateProgress("Ê≠£Âú®ÊâìÂåÖZIP...");
        const content = await zip.generateAsync({ type: "blob" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        link.download = `media_${new Date().toISOString().slice(0, 10)}.zip`;
        link.click();

        this.ui.updateProgress(`ÊâìÂåÖÂÆåÊàêÔºÅÂÖ± ${totalImages} Âº†ÂõæÁâá`);
        Utils.showNotification(
          `ZIPÊâìÂåÖÂÆåÊàêÔºåÂåÖÂê´ ${totalImages} Âº†ÂõæÁâá`,
          "success"
        );

        setTimeout(() => this.ui.updateProgress(""), 3000);
      } catch (error) {
        this.ui.updateProgress("ÊâìÂåÖ‰∏ãËΩΩÂ§±Ë¥•");
        Utils.showNotification("ÊâìÂåÖ‰∏ãËΩΩÂ§±Ë¥•: " + error.message, "error");
      }
    }

    adjustPageStyles() {
      try {
        const style = document.createElement("style");
        style.id = "page-tools-style-adjustments";
        style.textContent = `
          body { font-size: 16px !important; line-height: 1.6 !important; }
          p, div { max-width: 800px !important; margin: 0 auto !important; }
          img { max-width: 100% !important; height: auto !important; }
          * { font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif !important; }
        `;

        if (document.getElementById("page-tools-style-adjustments")) {
          document.getElementById("page-tools-style-adjustments").remove();
          Utils.showNotification("Â∑≤ÊÅ¢Â§çÂéüÂßãÊ†∑Âºè", "info");
        } else {
          document.head.appendChild(style);
          Utils.showNotification("Â∑≤Â∫îÁî®ÈòÖËØª‰ºòÂåñÊ†∑Âºè", "success");
        }
      } catch (error) {
        Utils.showNotification("Ê†∑ÂºèË∞ÉÊï¥Â§±Ë¥•: " + error.message, "error");
      }
    }

    showPageStats() {
      try {
        const stats = {
          links: document.getElementsByTagName("a").length,
          images: document.images.length,
          forms: document.forms.length,
          scripts: document.scripts.length,
          stylesheets: document.styleSheets.length,
          wordCount: document.body.innerText.trim().split(/\s+/).length,
        };

        const message = `
È°µÈù¢ÁªüËÆ°‰ø°ÊÅØÔºö
‚Ä¢ ÈìæÊé•Êï∞Èáè: ${stats.links}
‚Ä¢ ÂõæÁâáÊï∞Èáè: ${stats.images}
‚Ä¢ Ë°®ÂçïÊï∞Èáè: ${stats.forms}
‚Ä¢ ËÑöÊú¨Êï∞Èáè: ${stats.scripts}
‚Ä¢ Ê†∑ÂºèË°®Êï∞Èáè: ${stats.stylesheets}
‚Ä¢ ÊñáÂ≠óÊï∞Èáè: ${stats.wordCount}
        `.trim();

        alert(message);
      } catch (error) {
        Utils.showNotification("Ëé∑ÂèñÈ°µÈù¢ÁªüËÆ°Â§±Ë¥•: " + error.message, "error");
      }
    }

    showDeveloperTools() {
      try {
        const tools = [
          { name: "Êü•ÁúãÈ°µÈù¢Ê∫êÁ†Å", fn: () => this.viewPageSource() },
          { name: "Êü•ÁúãÂÖÉÁ¥†Ê†∑Âºè", fn: () => this.inspectElementStyles() },
          { name: "ÊÄßËÉΩÂàÜÊûê", fn: () => this.analyzePerformance() },
          { name: "ÁΩëÁªúËØ∑Ê±Ç", fn: () => this.showNetworkRequests() },
        ];

        const dialog = document.createElement("div");
        dialog.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          border: 1px solid #ccc;
          border-radius: 8px;
          padding: 20px;
          z-index: 1000004;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
        `;

        dialog.innerHTML = `
          <h3 style="margin: 0 0 15px 0; color: #333;">ÂºÄÂèëËÄÖÂ∑•ÂÖ∑</h3>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            ${tools
              .map(
                (tool) => `
              <button style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; cursor: pointer;">
                ${tool.name}
              </button>
            `
              )
              .join("")}
          </div>
          <button id="close-dev-tools" style="margin-top: 15px; padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ÂÖ≥Èó≠
          </button>
        `;

        document.body.appendChild(dialog);

        // ÁªëÂÆö‰∫ã‰ª∂
        tools.forEach((tool, index) => {
          dialog
            .querySelectorAll("button")
            [index].addEventListener("click", tool.fn);
        });

        dialog
          .querySelector("#close-dev-tools")
          .addEventListener("click", () => {
            document.body.removeChild(dialog);
          });
      } catch (error) {
        Utils.showNotification("ÊâìÂºÄÂºÄÂèëËÄÖÂ∑•ÂÖ∑Â§±Ë¥•: " + error.message, "error");
      }
    }

    viewPageSource() {
      const source = document.documentElement.outerHTML;
      const textarea = document.createElement("textarea");
      textarea.value = source;
      textarea.style.cssText = `
        position: fixed;
        top: 10%;
        left: 10%;
        width: 80%;
        height: 80%;
        z-index: 1000005;
        font-family: monospace;
        font-size: 12px;
        padding: 10px;
        border: 1px solid #ccc;
      `;

      const closeBtn = document.createElement("button");
      closeBtn.textContent = "ÂÖ≥Èó≠";
      closeBtn.style.cssText = `
        position: fixed;
        top: 5%;
        right: 5%;
        z-index: 1000006;
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      `;

      closeBtn.onclick = () => {
        document.body.removeChild(textarea);
        document.body.removeChild(closeBtn);
      };

      document.body.appendChild(textarea);
      document.body.appendChild(closeBtn);
    }

    inspectElementStyles() {
      Utils.showNotification("ÁÇπÂáªÂÖÉÁ¥†Êü•ÁúãÊ†∑Âºè‰ø°ÊÅØ", "info");

      const handleClick = (e) => {
        e.preventDefault();
        e.stopPropagation();

        const styles = window.getComputedStyle(e.target);
        const cssText = e.target.style.cssText;
        const className = e.target.className;
        const id = e.target.id;

        const info = `
ÂÖÉÁ¥†‰ø°ÊÅØÔºö
Ê†áÁ≠æ: ${e.target.tagName}
ID: ${id || "Êó†"}
Á±ªÂêç: ${className || "Êó†"}
ÂÜÖËÅîÊ†∑Âºè: ${cssText || "Êó†"}
ËÆ°ÁÆóÊ†∑Âºè: ${styles.cssText}
        `.trim();

        alert(info);
        document.removeEventListener("click", handleClick, true);
      };

      document.addEventListener("click", handleClick, true);
    }

    analyzePerformance() {
      const perfData = performance.getEntriesByType("navigation")[0];
      const timing = perfData
        ? {
            DNSÊü•ËØ¢: perfData.domainLookupEnd - perfData.domainLookupStart,
            TCPËøûÊé•: perfData.connectEnd - perfData.connectStart,
            ËØ∑Ê±ÇÂìçÂ∫î: perfData.responseEnd - perfData.requestStart,
            DOMËß£Êûê:
              perfData.domContentLoadedEventEnd -
              perfData.domContentLoadedEventStart,
            È°µÈù¢Âä†ËΩΩ: perfData.loadEventEnd - perfData.loadEventStart,
          }
        : {};

      const message = perfData
        ? `ÊÄßËÉΩÂàÜÊûêÔºö
‚Ä¢ DNSÊü•ËØ¢: ${timing["DNSÊü•ËØ¢"]}ms
‚Ä¢ TCPËøûÊé•: ${timing["TCPËøûÊé•"]}ms
‚Ä¢ ËØ∑Ê±ÇÂìçÂ∫î: ${timing["ËØ∑Ê±ÇÂìçÂ∫î"]}ms
‚Ä¢ DOMËß£Êûê: ${timing["DOMËß£Êûê"]}ms
‚Ä¢ È°µÈù¢Âä†ËΩΩ: ${timing["È°µÈù¢Âä†ËΩΩ"]}ms`
        : "Êó†Ê≥ïËé∑ÂèñÊÄßËÉΩÊï∞ÊçÆ";

      alert(message);
    }

    showNetworkRequests() {
      const resources = performance.getEntriesByType("resource");
      const stats = resources.reduce((acc, resource) => {
        const type = resource.initiatorType || "other";
        acc[type] = (acc[type] || 0) + 1;
        return acc;
      }, {});

      const message = `ÁΩëÁªúËØ∑Ê±ÇÁªüËÆ°Ôºö
${Object.entries(stats)
  .map(([type, count]) => `‚Ä¢ ${type}: ${count}‰∏™`)
  .join("\n")}
ÊÄªËÆ°: ${resources.length}‰∏™ËØ∑Ê±Ç`;

      alert(message);
    }
  }

  // ÂàùÂßãÂåñÂ∫îÁî®
  const ui = new UIManager();
  const features = new FeatureManager(ui);

  // Ê∏ÖÁêÜÂáΩÊï∞
  window.pageToolsCleanup = () => {
    if (features.hoverTip) {
      features.disableElementInspector();
    }
    if (window.originalPageContent) {
      document.body.innerHTML = window.originalPageContent;
    }
    if (document.getElementById("page-tools-style-adjustments")) {
      document.getElementById("page-tools-style-adjustments").remove();
    }
  };

  console.log("È°µÈù¢Â∑•ÂÖ∑Êâ©Â±ïÂ∑≤Âä†ËΩΩ");
})();
